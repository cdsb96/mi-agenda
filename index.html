<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Mi Agenda Diaria</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
  <link rel="manifest" href="manifest.webmanifest">
  <style>
    :root {
      /* Paleta autumn cozy */
      --bg: #f4e9dd;
      --bg-alt: #f7f0e6;
      --card-bg: #fff7ec;
      --accent: #b25c2e;
      --accent-soft: #f2c48d;
      --accent-dark: #7a3b20;
      --text-main: #3a2c28;
      --muted: #7b6a63;
      --shadow: rgba(120, 66, 20, 0.12);

      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color-scheme: light;
    }

    body {
      margin: 0;
      padding: 1rem;
      background: radial-gradient(circle at top left, #fbe9d0 0, var(--bg) 45%, #e9ddcf 100%);
      color: var(--text-main);
    }

    .app {
      max-width: 960px;
      margin: 0 auto;
      background: rgba(247, 240, 230, 0.85);
      border-radius: 1rem;
      padding: 1rem;
      box-shadow: 0 18px 45px rgba(87, 51, 20, 0.18);
      backdrop-filter: blur(6px);
    }

    h1 {
      font-size: 1.7rem;
      margin-bottom: 0.2rem;
      letter-spacing: 0.03em;
    }

    .subtitle {
      margin-top: 0;
      margin-bottom: 1rem;
      color: var(--muted);
      font-size: 0.95rem;
    }

    .top-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
      margin-bottom: 1rem;
      padding: 0.6rem 0.75rem;
      border-radius: 0.75rem;
      background: var(--bg-alt);
      border: 1px solid rgba(178, 92, 46, 0.15);
    }

    .top-bar label {
      font-size: 0.9rem;
      color: var(--accent-dark);
      font-weight: 600;
    }

    input[type="date"],
    input[type="text"],
    input[type="time"],
    textarea,
    button {
      font: inherit;
    }

    input[type="date"] {
      padding: 0.35rem 0.6rem;
      border-radius: 0.6rem;
      border: 1px solid rgba(178, 92, 46, 0.25);
      background: #fffaf3;
      color: var(--text-main);
    }

    input[type="date"]:focus {
      outline: 2px solid rgba(178, 92, 46, 0.35);
      outline-offset: 1px;
    }

    .cards-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 1rem;
    }

    @media (max-width: 700px) {
      .cards-grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: var(--card-bg);
      border-radius: 0.9rem;
      padding: 0.8rem 0.95rem;
      box-shadow: 0 8px 18px var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      border: 1px solid rgba(178, 92, 46, 0.12);
      position: relative;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0.45rem 0.85rem auto;
      height: 3px;
      border-radius: 999px;
      background: linear-gradient(90deg, var(--accent-soft), rgba(255, 255, 255, 0));
      opacity: 0.9;
    }

    .card h2 {
      margin: 0;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: var(--accent-dark);
    }

    .badge {
      font-size: 0.7rem;
      padding: 0.1rem 0.5rem;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent-dark);
      border: 1px solid rgba(122, 59, 32, 0.25);
    }

    .add-form {
      display: flex;
      gap: 0.4rem;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 0.1rem;
    }

    .add-form .item-text {
      flex: 1 1 160px;
      min-width: 0;
      padding: 0.3rem 0.5rem;
      border: 1px solid rgba(178, 92, 46, 0.25);
      border-radius: 0.6rem;
      background: #fffaf3;
    }

    .add-form .item-text:focus,
    .add-form .item-time:focus {
      outline: 2px solid rgba(178, 92, 46, 0.35);
      outline-offset: 1px;
    }

    .add-form .item-time {
      flex: 0 0 90px;
      padding: 0.3rem 0.45rem;
      border: 1px solid rgba(178, 92, 46, 0.25);
      border-radius: 0.6rem;
      background: #fffaf3;
    }

    .add-form button {
      flex: 0 0 auto;
      padding: 0.35rem 0.8rem;
      border-radius: 999px;
      border: none;
      background: var(--accent);
      color: #fffaf3;
      font-size: 0.8rem;
      cursor: pointer;
      white-space: nowrap;
      font-weight: 500;
      box-shadow: 0 4px 10px rgba(122, 59, 32, 0.28);
      transition: transform 0.05s ease, box-shadow 0.05s ease, background 0.1s ease;
    }

    .add-form button:hover {
      background: var(--accent-dark);
      box-shadow: 0 6px 14px rgba(122, 59, 32, 0.35);
    }

    .add-form button:active {
      transform: translateY(1px);
      box-shadow: 0 3px 8px rgba(122, 59, 32, 0.3);
    }

    .items-list {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      margin-top: 0.25rem;
      max-height: 270px;
      overflow-y: auto;
      padding-right: 0.25rem;
    }

    .item-row {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.9rem;
    }

    .item-row input[type="checkbox"] {
      width: 1rem;
      height: 1rem;
      accent-color: var(--accent-dark);
    }

    .item-label {
      display: flex;
      align-items: baseline;
      gap: 0.3rem;
      flex: 1;
    }

    .item-text-display {
      flex: 1;
      word-break: break-word;
    }

    .item-time-display {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .item-done .item-text-display {
      text-decoration: line-through;
      color: rgba(123, 106, 99, 0.7);
    }

    .notes-textarea {
      width: 100%;
      min-height: 180px;
      resize: vertical;
      padding: 0.5rem 0.6rem;
      border-radius: 0.7rem;
      border: 1px solid rgba(178, 92, 46, 0.22);
      background: #fffaf3;
      font-size: 0.9rem;
      color: var(--text-main);
    }

    .notes-help {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .section-description {
      font-size: 0.8rem;
      color: var(--muted);
      margin-top: -0.05rem;
      margin-bottom: 0.15rem;
    }

    .backlog-meta {
      font-size: 0.75rem;
      color: var(--muted);
      white-space: nowrap;
    }

    .backlog-actions button {
      padding: 0.22rem 0.65rem;
      border-radius: 999px;
      border: none;
      font-size: 0.75rem;
      cursor: pointer;
      background: #f4d1a8;
      color: var(--accent-dark);
      white-space: nowrap;
      box-shadow: 0 3px 7px rgba(122, 59, 32, 0.18);
    }

    .backlog-actions button:hover {
      background: #eabf8a;
    }

    .backlog-empty {
      font-size: 0.85rem;
      color: var(--muted);
    }

    .backlog-row {
      align-items: flex-start;
    }

    .backlog-main {
      display: flex;
      flex-direction: column;
      gap: 0.1rem;
      flex: 1;
    }

    .backlog-top {
      display: flex;
      gap: 0.4rem;
      align-items: baseline;
      flex-wrap: wrap;
    }

    .mini-guide {
      font-size: 0.8rem;
      color: var(--muted);
      margin-top: 0.25rem;
      background: rgba(244, 209, 168, 0.25);
      border-radius: 0.6rem;
      padding: 0.35rem 0.5rem;
      border: 1px dashed rgba(178, 92, 46, 0.35);
    }

    .mini-guide summary {
      cursor: pointer;
      font-weight: 600;
      list-style: none;
      color: var(--accent-dark);
    }

    .mini-guide summary::-webkit-details-marker {
      display: none;
    }

    .mini-guide summary::before {
      content: "‚ñ∏ ";
      font-size: 0.8rem;
    }

    .mini-guide[open] summary::before {
      content: "‚ñæ ";
    }

    .mini-guide ul {
      margin: 0.25rem 0 0 1rem;
      padding: 0;
    }

    .mini-guide li {
      margin-bottom: 0.2rem;
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>Mi agenda diaria</h1>
    <p class="subtitle">Organiza tus tareas, pastillas, limpieza, men√∫, self-care y Trufa en un sitio cozy üçÇ</p>

    <div class="top-bar">
      <label for="date">D√≠a:</label>
      <input type="date" id="date" />
      <span style="font-size:0.8rem; color:var(--muted);">
        Todo se guarda autom√°ticamente en este dispositivo.
      </span>
    </div>

    <!-- Temas pendientes (cualquier d√≠a) -->
    <section class="card">
      <h2>
        Temas pendientes
        <span class="badge">Sin tic</span>
      </h2>
      <p class="section-description">
        Tareas sin marcar de cualquier d√≠a. Puedes pasarlas al d√≠a actual para reagendar.
      </p>
      <div class="items-list" id="backlog-list"></div>
    </section>

    <div class="cards-grid">
      <!-- Cosas que hacer -->
      <section class="card">
        <h2>
          Cosas que hacer
          <span class="badge">To-dos</span>
        </h2>
        <p class="section-description">Tareas generales del d√≠a.</p>
        <form class="add-form add-item-form" data-section="tasks">
          <input type="text" class="item-text" placeholder="Ej: Llamar al m√©dico" required />
          <input type="time" class="item-time" />
          <button type="submit">A√±adir</button>
        </form>
        <div class="items-list" data-section="tasks"></div>
      </section>

      <!-- Pastillas / suplementos -->
      <section class="card">
        <h2>
          Pastillas / suplementos
          <span class="badge">Salud</span>
        </h2>
        <p class="section-description">Medicaci√≥n, suplementos, recordatorios de tomas.</p>
        <form class="add-form add-item-form" data-section="pills">
          <input type="text" class="item-text" placeholder="Ej: Ontozry noche" required />
          <input type="time" class="item-time" />
          <button type="submit">A√±adir</button>
        </form>
        <div class="items-list" data-section="pills"></div>
        <details class="mini-guide" id="pill-template-block">
          <summary>Plantilla diaria de pastillas (opcional)</summary>
          <p class="section-description">
            Lo que pongas aqu√≠ aparecer√° autom√°ticamente en cada d√≠a nuevo. Solo se guarda en este dispositivo.
          </p>
          <form class="add-form" id="pill-template-form">
            <input
              type="text"
              class="item-text"
              id="pill-template-text"
              placeholder="Ej: Ontozry ma√±ana"
              required
            />
            <input type="time" class="item-time" id="pill-template-time" />
            <button type="submit">A√±adir a plantilla</button>
          </form>
          <div class="items-list" id="pill-template-list"></div>
        </details>

      </section>

      <!-- Limpieza -->
      <section class="card">
        <h2>
          Limpieza
          <span class="badge">Casa</span>
        </h2>
        <p class="section-description">Cosas de orden y limpieza (diario o semanal).</p>
        <form class="add-form add-item-form" data-section="cleaning">
          <input type="text" class="item-text" placeholder="Ej: Poner lavadora" required />
          <input type="time" class="item-time" />
          <button type="submit">A√±adir</button>
        </form>
        <div class="items-list" data-section="cleaning"></div>
      </section>

      <!-- Men√∫ del d√≠a -->
      <section class="card">
        <h2>
          Men√∫ del d√≠a
          <span class="badge">Comidas</span>
        </h2>
        <p class="section-description">Plan de desayunos, comidas y cenas.</p>
        <form class="add-form add-item-form" data-section="menu">
          <input type="text" class="item-text" placeholder="Ej: Cena: salm√≥n con verduras" required />
          <input type="time" class="item-time" />
          <button type="submit">A√±adir</button>
        </form>
        <div class="items-list" data-section="menu"></div>
      </section>

      <!-- Self-care -->
      <section class="card">
        <h2>
          Self-care
          <span class="badge">Bienestar</span>
        </h2>
        <p class="section-description">Cosas que haces por ti: descanso, hobbies, etc.</p>
        <form class="add-form add-item-form" data-section="selfcare">
          <input type="text" class="item-text" placeholder="Ej: 10 min de estiramientos" required />
          <input type="time" class="item-time" />
          <button type="submit">A√±adir</button>
        </form>
        <div class="items-list" data-section="selfcare"></div>
      </section>

      <!-- Trufa (perro) -->
      <section class="card">
        <h2>
          Trufa
          <span class="badge">Perro</span>
        </h2>
        <p class="section-description">Veterinario, u√±as, peinar, lavar, etc.</p>
        <form class="add-form add-item-form" data-section="trufa">
          <input type="text" class="item-text" placeholder="Ej: Cita vet vacuna" required />
          <input type="time" class="item-time" />
          <button type="submit">A√±adir</button>
        </form>
        <div class="items-list" data-section="trufa"></div>

        <details class="mini-guide">
          <summary>Mini gu√≠a semanal para Trufa (ejemplo)</summary>
          <ul>
            <li><strong>Diario:</strong> revisar agua y comida, paseo tranquilo, 5‚Äì10 min de juego.</li>
            <li><strong>2‚Äì3 veces/semana:</strong> cepillar un poco el pelo, revisar almohadillas y u√±as.</li>
            <li><strong>Semanal:</strong> limpiar orejas (si lo recomienda el vet), revisar arn√©s/collar.</li>
            <li><strong>Mensual:</strong> antiparasitario, ba√±o, corte de u√±as (si toca).</li>
            <li><strong>Seg√∫n necesidad:</strong> pedir cita vet, revisar calendario de vacunas.</li>
          </ul>
        </details>
      </section>

      <!-- Notas generales -->
      <section class="card">
        <h2>
          Notas generales
          <span class="badge">Recordatorios</span>
        </h2>
        <p class="section-description">
          Cumplea√±os, cenas, viajes, cosas importantes del d√≠a‚Ä¶
        </p>
        <textarea
          id="general-notes"
          class="notes-textarea"
          placeholder="Ej: Cumple de Ana, cena con Marta, mirar vuelos para el viaje‚Ä¶"
        ></textarea>
        <p class="notes-help">
          Se guarda autom√°ticamente al escribir. Estas notas son solo para este d√≠a.
        </p>
      </section>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "mi-agenda-diaria-v1";
    const ALL_SECTIONS = ["tasks", "pills", "cleaning", "menu", "selfcare", "trufa"];
    const SECTION_LABELS = {
      tasks: "Cosas que hacer",
      pills: "Pastillas/suplementos",
      cleaning: "Limpieza",
      menu: "Men√∫",
      selfcare: "Self-care",
      trufa: "Trufa (perro)",
    };

    const PILL_TEMPLATE_KEY = "mi-agenda-pill-template-v1";
    const PILL_TEMPLATE_APPLIED_KEY = "mi-agenda-pill-template-applied-v1";

    function loadJson(key, fallback) {
      try {
        const raw = localStorage.getItem(key);
        return raw ? JSON.parse(raw) : fallback;
      } catch (e) {
        return fallback;
      }
    }

    let pillTemplate = loadJson(PILL_TEMPLATE_KEY, []);
    let pillTemplateAppliedDates = loadJson(PILL_TEMPLATE_APPLIED_KEY, []);

    function savePillTemplate() {
      try {
        localStorage.setItem(PILL_TEMPLATE_KEY, JSON.stringify(pillTemplate));
      } catch (e) {}
    }

    function savePillTemplateApplied() {
      try {
        localStorage.setItem(
          PILL_TEMPLATE_APPLIED_KEY,
          JSON.stringify(pillTemplateAppliedDates)
        );
      } catch (e) {}
    }

    function loadFromStorage() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : {};
      } catch (e) {
        console.error("Error cargando datos:", e);
        return {};
      }
    }

    function saveToStorage() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(plannerData));
      } catch (e) {
        console.error("Error guardando datos:", e);
      }
    }

    let plannerData = loadFromStorage();

    function todayISO() {
      const d = new Date();
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${year}-${month}-${day}`;
    }

    function getCurrentDateKey() {
      const dateInput = document.getElementById("date");
      return dateInput.value || todayISO();
    }

    function ensureDateStructure(dateKey) {
      if (!plannerData[dateKey]) {
        plannerData[dateKey] = {
          sections: {
            tasks: [],
            pills: [],
            cleaning: [],
            menu: [],
            selfcare: [],
            trufa: [],
          },
          notes: {
            general: "",
          },
        };
      } else {
        plannerData[dateKey].sections = plannerData[dateKey].sections || {};
        const s = plannerData[dateKey].sections;
        if (!s.tasks) s.tasks = [];
        if (!s.pills) s.pills = [];
        if (!s.cleaning) s.cleaning = [];
        if (!s.menu) s.menu = [];
        if (!s.selfcare) s.selfcare = [];
        if (s.etrufa && !s.trufa) {
          s.trufa = s.etrufa;
          delete s.etrufa;
        }
        if (!s.trufa) s.trufa = [];
        plannerData[dateKey].notes = plannerData[dateKey].notes || {};
        if (typeof plannerData[dateKey].notes.general !== "string") {
          plannerData[dateKey].notes.general = "";
        }
      }
    }

    function applyPillTemplate(dateKey) {
      if (!pillTemplate.length) return;
      if (pillTemplateAppliedDates.includes(dateKey)) return;

      ensureDateStructure(dateKey);
      const day = plannerData[dateKey];

      // Si ya hay pastillas escritas, no machacamos nada
      if (day.sections.pills && day.sections.pills.length > 0) {
        pillTemplateAppliedDates.push(dateKey);
        savePillTemplateApplied();
        return;
      }

      const now = Date.now();
      day.sections.pills = pillTemplate.map((tpl, index) => ({
        id: now + index + Math.random(),
        text: tpl.text,
        time: tpl.time || "",
        done: false,
        fromTemplate: true, // <- marcar como generadas desde plantilla
      }));

      pillTemplateAppliedDates.push(dateKey);
      savePillTemplateApplied();
      saveToStorage();
    }

    function renderSection(sectionId) {
      const dateKey = getCurrentDateKey();
      ensureDateStructure(dateKey);

      const container = document.querySelector(
        `.items-list[data-section="${sectionId}"]`
      );
      if (!container) return;

      const items = plannerData[dateKey].sections[sectionId] || [];
      container.innerHTML = "";

      items.forEach((item) => {
        const row = document.createElement("div");
        row.className = "item-row" + (item.done ? " item-done" : "");

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.className = "item-checkbox";
        checkbox.dataset.section = sectionId;
        checkbox.dataset.id = String(item.id);
        checkbox.dataset.date = dateKey;
        checkbox.checked = !!item.done;

        const label = document.createElement("div");
        label.className = "item-label";

        const textSpan = document.createElement("span");
        textSpan.className = "item-text-display";
        textSpan.textContent = item.text;

        label.appendChild(textSpan);

        if (item.time) {
          const timeSpan = document.createElement("span");
          timeSpan.className = "item-time-display";
          timeSpan.textContent = item.time;
          label.appendChild(timeSpan);
        }

        row.appendChild(checkbox);
        row.appendChild(label);
        container.appendChild(row);
      });
    }

    function renderPillTemplate() {
      const container = document.getElementById("pill-template-list");
      if (!container) return;

      container.innerHTML = "";

      if (!pillTemplate.length) {
        const p = document.createElement("p");
        p.className = "backlog-empty";
        p.textContent = "No hay nada en la plantilla todav√≠a.";
        container.appendChild(p);
        return;
      }

      pillTemplate.forEach((item) => {
        const row = document.createElement("div");
        row.className = "item-row";

        const label = document.createElement("div");
        label.className = "item-label";

        const textSpan = document.createElement("span");
        textSpan.className = "item-text-display";
        textSpan.textContent = item.text;

        label.appendChild(textSpan);

        if (item.time) {
          const timeSpan = document.createElement("span");
          timeSpan.className = "item-time-display";
          timeSpan.textContent = item.time;
          label.appendChild(timeSpan);
        }

        const actions = document.createElement("div");
        actions.className = "backlog-actions";

        const deleteBtn = document.createElement("button");
          deleteBtn.type = "button";
          deleteBtn.className = "pill-template-delete";
          deleteBtn.dataset.id = String(item.id);
          deleteBtn.textContent = "Quitar";

        actions.appendChild(deleteBtn);

        row.appendChild(label);
        row.appendChild(actions);

        container.appendChild(row);
      });
    }

    function handlePillTemplateAdd(event) {
      event.preventDefault();
      const textInput = document.getElementById("pill-template-text");
      const timeInput = document.getElementById("pill-template-time");

      const text = textInput.value.trim();
      const time = timeInput.value;

      if (!text) return;

      const newItem = {
        id: Date.now() + Math.random(),
        text,
        time: time || "",
      };

      pillTemplate.push(newItem);
      savePillTemplate();
      textInput.value = "";
      timeInput.value = "";

      renderPillTemplate();
    }

    function handlePillTemplateClick(event) {
      const btn = event.target.closest(".pill-template-delete");
      if (!btn) return;

      const id = btn.dataset.id;
      const index = pillTemplate.findIndex((it) => String(it.id) === String(id));
      if (index === -1) return;

      pillTemplate.splice(index, 1);
      savePillTemplate();
      renderPillTemplate();
    }

    function isDateKey(key) {
      return /^\d{4}-\d{2}-\d{2}$/.test(key);
    }

function gatherBacklog() {
  const pending = [];
  const today = todayISO();

  for (const [dateKey, dayData] of Object.entries(plannerData)) {
    if (!isDateKey(dateKey)) continue;

    // SOLO d√≠as pasados ‚Üí excluir hoy y d√≠as futuros
    if (dateKey >= today) continue;

    ensureDateStructure(dateKey);
    const sections = dayData.sections || {};

    ALL_SECTIONS.forEach((sectionId) => {
      const list = sections[sectionId] || [];
      list.forEach((item) => {
        if (item.done) return;

        // Excluir pastillas generadas por plantilla
        if (sectionId === "pills" && item.fromTemplate) return;

        pending.push({
          dateKey,
          sectionId,
          item,
        });
      });
    });
  }

  pending.sort((a, b) => {
    if (a.dateKey !== b.dateKey) {
      return a.dateKey.localeCompare(b.dateKey);
    }
    const ta = a.item.time || "";
    const tb = b.item.time || "";
    return ta.localeCompare(tb);
  });

  return pending;
}


      pending.sort((a, b) => {
        if (a.dateKey !== b.dateKey) {
          return a.dateKey.localeCompare(b.dateKey);
        }
        const ta = a.item.time || "";
        const tb = b.item.time || "";
        return ta.localeCompare(tb);
      });

      return pending;
    }

    function formatDateShort(dateKey) {
      const [y, m, d] = dateKey.split("-");
      return `${d}/${m}`;
    }

    function renderBacklog() {
      const container = document.getElementById("backlog-list");
      if (!container) return;

      const pending = gatherBacklog();
      container.innerHTML = "";

      if (!pending.length) {
        const p = document.createElement("p");
        p.className = "backlog-empty";
        p.textContent = "No hay nada pendiente üéâ";
        container.appendChild(p);
        return;
      }

      pending.forEach((entry) => {
        const { dateKey, sectionId, item } = entry;
        const row = document.createElement("div");
        row.className = "item-row backlog-row";

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.className = "item-checkbox";
        checkbox.dataset.section = sectionId;
        checkbox.dataset.id = String(item.id);
        checkbox.dataset.date = dateKey;
        checkbox.checked = !!item.done;

        const main = document.createElement("div");
        main.className = "backlog-main";

        const top = document.createElement("div");
        top.className = "backlog-top";

        const textSpan = document.createElement("span");
        textSpan.className = "item-text-display";
        textSpan.textContent = item.text;

        const metaSpan = document.createElement("span");
        metaSpan.className = "backlog-meta";
        metaSpan.textContent =
          `${formatDateShort(dateKey)} ¬∑ ${SECTION_LABELS[sectionId] || sectionId}` +
          (item.time ? ` ¬∑ ${item.time}` : "");

        top.appendChild(textSpan);
        top.appendChild(metaSpan);

        main.appendChild(top);

        const actions = document.createElement("div");
        actions.className = "backlog-actions";

        const moveBtn = document.createElement("button");
        moveBtn.type = "button";
        moveBtn.className = "backlog-move-btn";
        moveBtn.dataset.date = dateKey;
        moveBtn.dataset.section = sectionId;
        moveBtn.dataset.id = String(item.id);
        moveBtn.textContent = "Pasar al d√≠a actual";

        actions.appendChild(moveBtn);
        main.appendChild(actions);

        row.appendChild(checkbox);
        row.appendChild(main);
        container.appendChild(row);
      });
    }

    function renderAll() {
      const dateKey = getCurrentDateKey();
      ensureDateStructure(dateKey);
      applyPillTemplate(dateKey);

      const sections = ALL_SECTIONS;
      sections.forEach(renderSection);

      const notesArea = document.getElementById("general-notes");
      notesArea.value = plannerData[dateKey].notes.general || "";

      renderPillTemplate();
      renderBacklog();
    }

    function handleAddItem(event) {
      event.preventDefault();
      const form = event.target;
      const sectionId = form.dataset.section;
      const textInput = form.querySelector(".item-text");
      const timeInput = form.querySelector(".item-time");

      const text = textInput.value.trim();
      const time = timeInput.value;

      if (!text) return;

      const dateKey = getCurrentDateKey();
      ensureDateStructure(dateKey);
      const sectionList = plannerData[dateKey].sections[sectionId];

      const newItem = {
        id: Date.now() + Math.random(),
        text,
        time: time || "",
        done: false,
      };

      sectionList.push(newItem);
      saveToStorage();

      textInput.value = "";
      timeInput.value = "";
      renderSection(sectionId);
      renderBacklog();
    }

    function handleCheckboxChange(event) {
      const checkbox = event.target;
      if (!checkbox.classList.contains("item-checkbox")) return;

      const sectionId = checkbox.dataset.section;
      const itemId = checkbox.dataset.id;
      const dateKey = checkbox.dataset.date || getCurrentDateKey();

      ensureDateStructure(dateKey);
      const list = plannerData[dateKey].sections[sectionId] || [];
      const item = list.find((it) => String(it.id) === String(itemId));
      if (item) {
        item.done = checkbox.checked;
        saveToStorage();
        if (dateKey === getCurrentDateKey()) {
          renderSection(sectionId);
        }
        renderBacklog();
      }
    }

    function handleNotesInput(event) {
      const dateKey = getCurrentDateKey();
      ensureDateStructure(dateKey);
      plannerData[dateKey].notes.general = event.target.value;
      saveToStorage();
    }

    function handleBacklogClick(event) {
      const btn = event.target.closest(".backlog-move-btn");
      if (!btn) return;

      const fromDate = btn.dataset.date;
      const sectionId = btn.dataset.section;
      const itemId = btn.dataset.id;
      const toDate = getCurrentDateKey();

      ensureDateStructure(fromDate);
      ensureDateStructure(toDate);

      const fromList = plannerData[fromDate].sections[sectionId] || [];
      const index = fromList.findIndex((it) => String(it.id) === String(itemId));
      if (index === -1) return;

      const [item] = fromList.splice(index, 1);
      plannerData[toDate].sections[sectionId].push(item);
      saveToStorage();
      renderAll();
    }

    document.addEventListener("DOMContentLoaded", () => {
      const dateInput = document.getElementById("date");
      dateInput.value = todayISO();

      dateInput.addEventListener("change", () => {
        renderAll();
      });

      document
        .querySelectorAll(".add-item-form")
        .forEach((form) => form.addEventListener("submit", handleAddItem));

      document.addEventListener("change", handleCheckboxChange);
      document.addEventListener("click", handleBacklogClick);

      document
        .getElementById("general-notes")
        .addEventListener("input", handleNotesInput);

      const pillTemplateForm = document.getElementById("pill-template-form");
      const pillTemplateList = document.getElementById("pill-template-list");

      if (pillTemplateForm) {
        pillTemplateForm.addEventListener("submit", handlePillTemplateAdd);
      }
      if (pillTemplateList) {
        pillTemplateList.addEventListener("click", handlePillTemplateClick);
      }

      renderAll();
    });
  </script>
</body>
</html>

